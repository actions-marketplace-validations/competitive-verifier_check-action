name: Test

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        index: [0, 1, 2, 3]
    steps:
      - uses: actions/checkout@v3

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ runner.os }}-competitive-verifier-result-${{ matrix.index }}
          path: tests/pyres${{ matrix.index }}/competitive-verifier-result.json
          retention-days: ${{ inputs.retention-days }}

  test:
    runs-on: ubuntu-latest
    needs: upload
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check local
        id: check-local
        uses: ./
        with:
          local-result-path: tests/pyres*/competitive-verifier-result.json
      - name: Test local
        run: |
          [ "${{ steps.check-local.outcome }}" = "success" ]
          [ "${{ steps.check-local.outputs.result-count }}" = "3" ]

      - name: Check artifact
        id: check-artifact
        uses: ./
      - name: Test artifact
        run: |
          [ "${{ steps.check-artifact.outcome }}" = "success" ]
          [ "${{ steps.check-artifact.outputs.result-count }}" = "3" ]

      - name: Check empty
        id: check-empty
        uses: ./
        with:
          local-result-path: tests/pyres3/competitive-verifier-result.json
      - name: Test local
        run: |
          [ "${{ steps.check-empty.outcome }}" = "success" ]
          [ "${{ steps.check-empty.outputs.result-count }}" = "0" ]

      - name: Check failure
        id: check-failure
        continue-on-error: true
        uses: ./
        with:
          local-result-path: tests/failure-result.json
      - name: Test failure
        run: |
          [ "${{ steps.check-failure.outcome }}" = "failure" ]
          [ "${{ steps.check-failure.outputs.result-count }}" = "1" ]
